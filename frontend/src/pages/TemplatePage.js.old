import React, { useState, useEffect } from 'react';
import axios from 'axios';
import '../styles/TemplatePage.css';

const TemplatePage = () => {
  const [formData, setFormData] = useState({
    friendlyName: '',
    language: 'pt_BR',
    contentType: 'twilio/text',
    body: '',
    variables: [],
    submitForWhatsApp: true,
    category: 'UTILITY'
  });

  const [preview, setPreview] = useState('');
  const [audienceOptions, setAudienceOptions] = useState({
    region: '',
    tone: '',
    offerType: '',
    psychologicalTrigger: '',
    ageRange: '',
    marketNiche: '',
    customMarketNiche: ''
  });

  const [isLoading, setIsLoading] = useState(false);

  const psychologicalTriggers = ['escassez', 'urgência', 'prova social', 'autoridade', 'reciprocidade'];
  const ageRanges = ['18 a 24 anos', '25 a 40 anos', '41 a 60 anos', '60+'];
  const offerTypes = ['desconto exclusivo', 'frete grátis', 'combo especial', 'brinde na compra', 'cobrança'];
  const marketNiches = ['cosméticos naturais', 'fitness', 'educação online', 'moda sustentável', 'tecnologia', 'outro'];

  const extractVariables = (bodyText) => {
    const regex = /\{\{(\d+)\}\}/g;
    const numbers = new Set();
    let match;
    while ((match = regex.exec(bodyText)) !== null) {
      numbers.add(match[1]);
    }
    const max = Math.max(0, ...Array.from(numbers).map(n => parseInt(n)));
    return Array.from({ length: max }, (_, i) => formData.variables[i] || '');
  };

  useEffect(() => {
    const vars = extractVariables(formData.body);
    setFormData(prev => ({ ...prev, variables: vars }));
  }, [formData.body]);

  useEffect(() => {
    generatePreview();
  }, [formData.body, formData.variables]);

  const handleVariableChange = (index, value) => {
    const updated = [...formData.variables];
    updated[index] = value;
    setFormData(prev => ({ ...prev, variables: updated }));
  };

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handleAudienceChange = (e) => {
    const { name, value } = e.target;
    setAudienceOptions(prev => ({
      ...prev,
      [name]: value
    }));

    if (name === 'region') {
      if (value === 'br') setFormData(prev => ({ ...prev, language: 'pt_BR' }));
      else if (['co', 'mx', 'pe', 'ar', 'cl'].includes(value)) setFormData(prev => ({ ...prev, language: 'es_MX' }));
      else setFormData(prev => ({ ...prev, language: 'en_US' }));
    }
  };

  const generatePreview = () => {
    let msg = formData.body;
    formData.variables.forEach((val, i) => {
      msg = msg.replace(`{{${i + 1}}}`, val || `{{${i + 1}}}`);
    });
    setPreview(msg);
  };

  const handleSubmit = async () => {
    const variableMap = {};
    formData.variables.forEach((val, idx) => {
      variableMap[(idx + 1).toString()] = val;
    });

    const payload = {
      name: formData.friendlyName,
      language: formData.language,
      variables: variableMap,
      types: {
        [formData.contentType]: {
          body: formData.body
        }
      },
      autoSubmit: formData.submitForWhatsApp,
      category: formData.category.toUpperCase()
    };

    try {
      const response = await axios.post('http://localhost:3001/api/templates/create', payload);
      alert('Template criado com sucesso!');
    } catch (err) {
      alert('Erro ao criar template: ' + (err.response?.data?.message || err.message));
    }
  };

  const handleSuggestWithAI = async () => {
    setIsLoading(true);
    try {
      const payload = {
        ...audienceOptions,
        marketNiche:
          audienceOptions.marketNiche === 'outro'
            ? audienceOptions.customMarketNiche
            : audienceOptions.marketNiche
      };

      const res = await axios.post('http://localhost:3001/api/ai/suggest-copy', payload);
      setFormData(prev => ({ ...prev, body: res.data.suggestion }));
    } catch (err) {
      alert('Erro ao gerar sugestão com IA');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="container">
      <div className="form">
        <h2>Criar Template</h2>

        <label>Friendly Name</label>
        <input name="friendlyName" value={formData.friendlyName} onChange={handleChange} />

        <label>Language</label>
        <input name="language" value={formData.language} onChange={handleChange} disabled />

        <label>Content Type</label>
        <select name="contentType" value={formData.contentType} onChange={handleChange}>
          <option value="twilio/text">twilio/text</option>
          <option value="twilio/media">twilio/media</option>
          <option value="twilio/template">twilio/template</option>
        </select>

        <label>Body</label>
        <textarea name="body" value={formData.body} onChange={handleChange} />

        {formData.variables.map((val, index) => (
          <div key={index}>
            <label>{`Valor da variável ${index + 1}`}</label>
            <input value={val} onChange={e => handleVariableChange(index, e.target.value)} />
          </div>
        ))}

        <button
          onClick={handleSuggestWithAI}
          style={{ backgroundColor: '#007bff' }}
          disabled={isLoading}
        >
          {isLoading ? 'Gerando...' : 'Gerar com IA'}
        </button>

        <label>Região</label>
        <select name="region" value={audienceOptions.region} onChange={handleAudienceChange}>
          <option value="">--</option>
          <option value="br">Brasil</option>
          <option value="co">Colômbia</option>
          <option value="mx">México</option>
          <option value="pe">Peru</option>
          <option value="ar">Argentina</option>
          <option value="cl">Chile</option>
          <option value="us">Estados Unidos</option>
          <option value="intl">Outro / Internacional</option>
        </select>

        <label>Tom</label>
        <select name="tone" value={audienceOptions.tone} onChange={handleAudienceChange}>
          <option value="">--</option>
          <option value="informal">Informal</option>
          <option value="urgente">Urgente</option>
          <option value="profissional">Profissional</option>
          <option value="amistoso">Amistoso</option>
          <option value="sério">Sério</option>
        </select>

        <label>Tipo de Oferta</label>
        <select name="offerType" value={audienceOptions.offerType} onChange={handleAudienceChange}>
          <option value="">--</option>
          {offerTypes.map((opt, i) => (
            <option key={i} value={opt}>{opt}</option>
          ))}
        </select>

        <label>Gatilho Psicológico</label>
        <select name="psychologicalTrigger" value={audienceOptions.psychologicalTrigger} onChange={handleAudienceChange}>
          <option value="">--</option>
          {psychologicalTriggers.map((opt, i) => (
            <option key={i} value={opt}>{opt}</option>
          ))}
        </select>

        <label>Faixa Etária</label>
        <select name="ageRange" value={audienceOptions.ageRange} onChange={handleAudienceChange}>
          <option value="">--</option>
          {ageRanges.map((opt, i) => (
            <option key={i} value={opt}>{opt}</option>
          ))}
        </select>

        <label>Nicho de Mercado</label>
        <select name="marketNiche" value={audienceOptions.marketNiche} onChange={handleAudienceChange}>
          <option value="">--</option>
          {marketNiches.map((opt, i) => (
            <option key={i} value={opt}>{opt}</option>
          ))}
        </select>

        {audienceOptions.marketNiche === 'outro' && (
          <input
            name="customMarketNiche"
            placeholder="Descreva seu nicho"
            value={audienceOptions.customMarketNiche}
            onChange={handleAudienceChange}
          />
        )}

        <label>
          <input
            type="checkbox"
            name="submitForWhatsApp"
            checked={formData.submitForWhatsApp}
            onChange={handleChange}
          /> Submeter para aprovação no WhatsApp
        </label>

        <label>Categoria</label>
        <select name="category" value={formData.category} onChange={handleChange}>
          <option value="UTILITY">Utility</option>
          <option value="MARKETING">Marketing</option>
          <option value="TRANSACTIONAL">Transactional</option>
        </select>

        <div className="button-group">
          <button onClick={handleSubmit}>Criar Template</button>
        </div>
      </div>

      <div className="preview">
        <h4>Message Preview</h4>
        <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>{preview}</pre>
      </div>
    </div>
  );
};

export default TemplatePage;

