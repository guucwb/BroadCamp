import React, { useEffect, useState } from 'react';
import { saveAs } from 'file-saver';

export default function HistoryPage() {
  const [history, setHistory] = useState([]);
  const [templateMap, setTemplateMap] = useState({});
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');

  useEffect(() => {
    fetch('/api/history')
      .then(res => res.json())
      .then(data => setHistory(data))
      .catch(err => console.error('Erro ao buscar histórico:', err));
  }, []);

  useEffect(() => {
    fetch('/api/templates/list')
      .then(res => res.json())
      .then(data => {
        const map = {};
        data.contents.forEach(t => {
          map[t.sid] = t.friendly_name;
        });
        setTemplateMap(map);
      })
      .catch(err => console.error('Erro ao buscar templates:', err));
  }, []);

  const exportCSV = () => {
    const rows = [["Data", "Template", "Canal", "Total", "Destinatário"]];
    filteredHistory.forEach(item => {
      item.recipients.forEach(recipient => {
        rows.push([
          new Date(item.timestamp).toLocaleString(),
          templateMap[item.templateSid] || item.templateSid,
          item.channel,
          item.total,
          recipient
        ]);
      });
    });

    const csvContent = rows.map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    saveAs(blob, `historico_disparos_${Date.now()}.csv`);
  };

  const filteredHistory = history.filter(item => {
    const itemDate = new Date(item.timestamp);
    if (startDate && itemDate < new Date(startDate)) return false;
    if (endDate && itemDate > new Date(endDate)) return false;
    return true;
  });

  return (
    <div className="p-6 max-w-6xl mx-auto">
      <h1 className="text-3xl font-bold mb-6 text-center">Histórico de Campanhas</h1>

      <div className="flex flex-wrap gap-4 items-end mb-6">
        <div>
          <label className="block text-sm font-medium text-gray-700">Data início:</label>
          <input
            type="date"
            className="border rounded px-3 py-1"
            value={startDate}
            onChange={e => setStartDate(e.target.value)}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">Data fim:</label>
          <input
            type="date"
            className="border rounded px-3 py-1"
            value={endDate}
            onChange={e => setEndDate(e.target.value)}
          />
        </div>
        <button
          className="ml-auto bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          onClick={exportCSV}
        >
          Exportar CSV
        </button>
      </div>

      {filteredHistory.length === 0 ? (
        <p className="text-gray-500 text-center">Nenhum histórico encontrado no período.</p>
      ) : (
        <div className="grid grid-cols-1 gap-6">
          {filteredHistory.map((item, index) => (
            <div
              key={index}
              className="border rounded-xl shadow-lg p-5 bg-white transition transform hover:scale-[1.01]"
            >
              <div className="flex justify-between items-center border-b pb-2 mb-3">
                <span className="text-sm text-gray-600">
                  {new Date(item.timestamp).toLocaleString()}
                </span>
                <span
                  className={`text-xs px-3 py-1 rounded-full font-medium uppercase ${
                    item.channel === 'sms'
                      ? 'bg-blue-100 text-blue-700'
                      : 'bg-green-100 text-green-700'
                  }`}
                >
                  {item.channel}
                </span>
              </div>
              <div className="mb-2">
                <span className="font-semibold text-gray-800">Template:</span>
                <span className="ml-2 text-gray-700">
                  {templateMap[item.templateSid] || item.templateSid}
                </span>
              </div>
              <div>
                <span className="font-semibold text-gray-800">Total de destinatários:</span>{' '}
                <span className="text-gray-700">{item.total}</span>
              </div>
              {item.recipients && item.recipients.length > 0 && (
                <details className="mt-3 text-sm text-gray-600">
                  <summary className="cursor-pointer text-blue-600 hover:underline">
                    Ver destinatários
                  </summary>
                  <ul className="ml-4 mt-2 list-disc">
                    {item.recipients.map((r, i) => (
                      <li key={i}>{r}</li>
                    ))}
                  </ul>
                </details>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

